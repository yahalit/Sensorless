/*
 * ProjMath.c
 *
 *  Created on: Apr 7, 2025
 *      Author: user
 */

#include "..\Application\StructDef2.h"


/*
 * Ready regression structure for new cycle
 */
void ClearRegression(struct CRegression * r)
{
    r->N = 0 ; r->x = 0 ; r->x2 = 0 ; r->xy = 0 ; r->y = 0 ;
}

/*
 * Add a data item to a regression structure
 */
void RegressionAddXY( struct CRegression * r , float x , float y )
{
    r->N += 1 ;
    r->x += x ;
    r->x2 += (x*x) ;
    r->xy += x*y ;
    r->y += y ;
}

/*
 * Solve regression based on collected data
 */
short RegressionSolve( struct CRegression * r , float *a , float *b )
{
    float det = r->N * r->x2 - r->x * r->x ;
    if ( det <= 1e-8 )
    {
        *a = 0 ; *b = 0 ; return -1 ;
    }
    det = 1/det ;
    *a = ( r->N * r->xy - r->x * r->y ) * det ;
    *b = ( -r->x * r->xy + r->x2 * r->y ) * det ;
    return 0 ;
}

#define OneOverLog2OfE 0.693147180559945f

/*
 * Find the time to reach a certain current level given R,L and Vdc
 * The current is I = Vdc/r ( 1 - exp(-t * L/R) ), so t = -log( 1 - I * r/Vdc) * R / L
 */
float TimeForCurrent( float I , float r , float L , float Vdc)
{
    float temp ;
    temp = 1 - fabsf(I) * r / __fmax(Vdc,0.01f)  ;
    if ( temp < 0.0001f)
    {
        return  1e8 ; // Not enough voltage to get current
    }
    return (-__log2(temp) *  OneOverLog2OfE * r / __fmax( L , 1.0e-7f)) ;
}



const float phitab[] = {
0.33333333f,-0.16666667f,-0.16666667f,0.33333333f,-0.16666667f,-0.16666667f,0.33333333f,0.16666667f,-0.16666667f,-0.33333333f,-0.16666667f,0.16666667f,
0.32692843f,-0.21978194f,-0.10714649f,0.32692843f,-0.21978194f,-0.10714649f,0.32692843f,0.10714649f,-0.21978194f,-0.32692843f,-0.10714649f,0.21978194f,
0.30795984f,-0.26445111f,-0.04350873f,0.30795984f,-0.26445111f,-0.04350873f,0.30795984f,0.04350873f,-0.26445111f,-0.30795984f,-0.04350873f,0.26445111f,
0.27715654f,-0.29895758f,0.02180104f,0.27715654f,-0.29895758f,0.02180104f,0.27715654f,-0.02180104f,-0.29895758f,-0.27715654f,0.02180104f,0.29895758f,
0.23570226f,-0.32197528f,0.08627302f,0.23570226f,-0.32197528f,0.08627302f,0.23570226f,-0.08627302f,-0.32197528f,-0.23570226f,0.08627302f,0.32197528f,
0.18519008f,-0.33261964f,0.14742956f,0.18519008f,-0.33261964f,0.14742956f,0.18519008f,-0.14742956f,-0.33261964f,-0.18519008f,0.14742956f,0.33261964f,
0.12756114f,-0.33048162f,0.20292048f,0.12756114f,-0.33048162f,0.20292048f,0.12756114f,-0.20292048f,-0.33048162f,-0.12756114f,0.20292048f,0.33048162f,
0.06503011f,-0.31564338f,0.25061327f,0.06503011f,-0.31564338f,0.25061327f,0.06503011f,-0.25061327f,-0.31564338f,-0.06503011f,0.25061327f,0.31564338f,
0.00000000f,-0.28867513f,0.28867513f,-0.00000000f,-0.28867513f,0.28867513f,0.00000000f,-0.28867513f,-0.28867513f,-0.00000000f,0.28867513f,0.28867513f,
-0.06503011f,-0.25061327f,0.31564338f,-0.06503011f,-0.25061327f,0.31564338f,-0.06503011f,-0.31564338f,-0.25061327f,0.06503011f,0.31564338f,0.25061327f,
-0.12756114f,-0.20292048f,0.33048162f,-0.12756114f,-0.20292048f,0.33048162f,-0.12756114f,-0.33048162f,-0.20292048f,0.12756114f,0.33048162f,0.20292048f,
-0.18519008f,-0.14742956f,0.33261964f,-0.18519008f,-0.14742956f,0.33261964f,-0.18519008f,-0.33261964f,-0.14742956f,0.18519008f,0.33261964f,0.14742956f,
-0.23570226f,-0.08627302f,0.32197528f,-0.23570226f,-0.08627302f,0.32197528f,-0.23570226f,-0.32197528f,-0.08627302f,0.23570226f,0.32197528f,0.08627302f,
-0.27715654f,-0.02180104f,0.29895758f,-0.27715654f,-0.02180104f,0.29895758f,-0.27715654f,-0.29895758f,-0.02180104f,0.27715654f,0.29895758f,0.02180104f,
-0.30795984f,0.04350873f,0.26445111f,-0.30795984f,0.04350873f,0.26445111f,-0.30795984f,-0.26445111f,0.04350873f,0.30795984f,0.26445111f,-0.04350873f,
-0.32692843f,0.10714649f,0.21978194f,-0.32692843f,0.10714649f,0.21978194f,-0.32692843f,-0.21978194f,0.10714649f,0.32692843f,0.21978194f,-0.10714649f,
-0.33333333f,0.16666667f,0.16666667f,-0.33333333f,0.16666667f,0.16666667f,-0.33333333f,-0.16666667f,0.16666667f,0.33333333f,0.16666667f,-0.16666667f,
-0.32692843f,0.21978194f,0.10714649f,-0.32692843f,0.21978194f,0.10714649f,-0.32692843f,-0.10714649f,0.21978194f,0.32692843f,0.10714649f,-0.21978194f,
-0.30795984f,0.26445111f,0.04350873f,-0.30795984f,0.26445111f,0.04350873f,-0.30795984f,-0.04350873f,0.26445111f,0.30795984f,0.04350873f,-0.26445111f,
-0.27715654f,0.29895758f,-0.02180104f,-0.27715654f,0.29895758f,-0.02180104f,-0.27715654f,0.02180104f,0.29895758f,0.27715654f,-0.02180104f,-0.29895758f,
-0.23570226f,0.32197528f,-0.08627302f,-0.23570226f,0.32197528f,-0.08627302f,-0.23570226f,0.08627302f,0.32197528f,0.23570226f,-0.08627302f,-0.32197528f,
-0.18519008f,0.33261964f,-0.14742956f,-0.18519008f,0.33261964f,-0.14742956f,-0.18519008f,0.14742956f,0.33261964f,0.18519008f,-0.14742956f,-0.33261964f,
-0.12756114f,0.33048162f,-0.20292048f,-0.12756114f,0.33048162f,-0.20292048f,-0.12756114f,0.20292048f,0.33048162f,0.12756114f,-0.20292048f,-0.33048162f,
-0.06503011f,0.31564338f,-0.25061327f,-0.06503011f,0.31564338f,-0.25061327f,-0.06503011f,0.25061327f,0.31564338f,0.06503011f,-0.25061327f,-0.31564338f,
-0.00000000f,0.28867513f,-0.28867513f,0.00000000f,0.28867513f,-0.28867513f,-0.00000000f,0.28867513f,0.28867513f,0.00000000f,-0.28867513f,-0.28867513f,
0.06503011f,0.25061327f,-0.31564338f,0.06503011f,0.25061327f,-0.31564338f,0.06503011f,0.31564338f,0.25061327f,-0.06503011f,-0.31564338f,-0.25061327f,
0.12756114f,0.20292048f,-0.33048162f,0.12756114f,0.20292048f,-0.33048162f,0.12756114f,0.33048162f,0.20292048f,-0.12756114f,-0.33048162f,-0.20292048f,
0.18519008f,0.14742956f,-0.33261964f,0.18519008f,0.14742956f,-0.33261964f,0.18519008f,0.33261964f,0.14742956f,-0.18519008f,-0.33261964f,-0.14742956f,
0.23570226f,0.08627302f,-0.32197528f,0.23570226f,0.08627302f,-0.32197528f,0.23570226f,0.32197528f,0.08627302f,-0.23570226f,-0.32197528f,-0.08627302f,
0.27715654f,0.02180104f,-0.29895758f,0.27715654f,0.02180104f,-0.29895758f,0.27715654f,0.29895758f,0.02180104f,-0.27715654f,-0.29895758f,-0.02180104f,
0.30795984f,-0.04350873f,-0.26445111f,0.30795984f,-0.04350873f,-0.26445111f,0.30795984f,0.26445111f,-0.04350873f,-0.30795984f,-0.26445111f,0.04350873f,
0.32692843f,-0.10714649f,-0.21978194f,0.32692843f,-0.10714649f,-0.21978194f,0.32692843f,0.21978194f,-0.10714649f,-0.32692843f,-0.21978194f,0.10714649f};

const float avgc = 0.235702260395516f ;


float cost[34] ;
/*
 * Optimize a model L = L0 + L1 * cos( theta + phi) + L2 * cos(theta*2+phi)
 * Because all the functions of fit (const, cos (tht+phi) , cos(2*tht+phi) are orthogonal over the interval, the summed squared error of fit = const - L0^2 - L1^2 - L2^2
 * Thus minimizing the LS target is equivalent to maximizing L0^2 + L1^2 + L2^2.
 * L0 is simply the sample of average. L1 and L2 are obtained as [1,0,0] * (H'*H)\H' Y  and [0,1,0] * (H'*H)\H' Y
 * The above PhiTab is a row of 12 numbers, the first 6 is s [1,0,0] * (H'*H)\H', the next 6 are [0,1,0] * (H'*H)\H'  , each row for  another assumption of phi (row n, n = 0..31 : phi = 2 * pi / 32 * n )
 */
float GetPhiOptimizeHars1And2(float rslt[6])
{
    const float *pNext = phitab ;
    float  L2 , L1 ,Lc ;
    float Costn ;
    float PhiOpt , den ;
    float NegMaxCost = -1 ;
    short nCost = 0 ;
    short cnt ;

    for ( cnt = 1 ; cnt <= 32 ; cnt++)
    {
        L2 = *pNext++ * rslt[0] + *pNext++ * rslt[1] +*pNext++ * rslt[2] +*pNext++ * rslt[3] +*pNext++ * rslt[5] +*pNext++ * rslt[5] ;
        L1 = *pNext++ * rslt[0] + *pNext++ * rslt[1] +*pNext++ * rslt[2] +*pNext++ * rslt[3] +*pNext++ * rslt[5] +*pNext++ * rslt[5] ;
        Lc = avgc * ( *pNext++ + *pNext++ + *pNext++ + *pNext++ + *pNext++ + *pNext++ );
        Costn = L2 * L2 + L1 * L1 + Lc * Lc ;
        cost[cnt] = Costn ;
        if ( Costn > NegMaxCost)
        {
            Costn = NegMaxCost ;
            nCost = cnt ;
        }
    }
    // Make continuity
    cost[0]  = cost[32] ;
    cost[33] = cost[1] ;


    den = cost[nCost+1] + cost[nCost-1] - 2 * cost[nCost];
    if ( den > -1e-8f )
    { // Points are co-linear, or nearly so, or this was a minimum
        PhiOpt = nCost * 0.098174770424681f ;
    }
    else
    {
        PhiOpt = ( (cost[nCost-1] - cost[nCost+1]) / den + nCost ) * 0.098174770424681f  ;
    }
    return PhiOpt ;
}




/*
 * GetLSCost Find cost of LS solution
 */
float GetLSCost(float h[3][3], float tht[3])
{
    return -(tht[0]*h[0][0] + tht[1]*h[1][0] + tht[2]*h[2][0])*tht[0] + (tht[0]*h[1][0] + tht[1]*h[1][1] + tht[2]*h[2][1])*tht[1] + (tht[0]*h[2][0] + tht[1]*h[2][1] + tht[2]*h[2][2])*tht[2] ;
}
